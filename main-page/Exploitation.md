[主页](./../README.md)        [上一页](./Vulnerability_Analysis.md)        [下一页](./Post_Exploitation.md)

# 阶段 5 漏洞利用

## 1 目的 (_Purpose_)

        渗透测试的利用阶段专注于通过绕过安全限制来建立对系统或资源的访问。如果前一个阶段，即漏洞分析，已正确执行，那么这一阶段应该是经过良好计划的精确打击。主要重点是识别进入组织的主要入口点和识别高价值目标资产。

        如果漏洞分析阶段已正确完成，那么应编制一个高价值目标列表。最终，攻击向量应该考虑成功概率和对组织的最大影响。

## 2 对策 (_Countermeasures_)

        对策被定义为妨碍成功完成利用途径的预防性技术或控制措施。这些技术可以是主机入侵防御系统、安全防护、Web应用防火墙或其他预防方法。在执行利用时，应考虑多个因素。在存在预防性技术的情况下，应考虑规避技术。在无法规避的情况下，应考虑替代的利用方法。

        总体而言，目的是在攻击组织时保持隐蔽，如果触发了警报，评估的级别可能会降低。如果可能的话，应该在触发利用之前枚举对策。这可以通过进行攻击的演练或枚举技术来实现。

### 2.1 防病毒 (_Anti-Virus_)

        防病毒技术旨在防止恶意软件在系统上部署。作为渗透测试者，我们应能够识别这些类型的防病毒技术，并能够抵御它们。防病毒只是所有不同预防措施中的一个小子集，例如主机入侵防御系统、Web应用防火墙和其他预防技术。

#### 2.1.1 编码 (_Encoding_)

        编码是一种以使已部署代码不呈现相同形式的方式混淆数据的方法。通过编码，通常通过扰乱信息并重新排列来隐藏应用程序实际在做什么的事实。

#### 2.1.2 压缩 (_Packing_)

        压缩在某种意义上与编码类似，它试图重新排列数据以压缩应用程序或“打包”它。希望通过这种方式交付的可执行文件或代码片段能够被混淆，避免被防病毒技术检测到。

#### 2.1.3 加密 (_Encrypting_)

        加密与编码和压缩类似，是另一种操纵预期可运行代码的方法，使其不易识别或检查。只有在内存中解密之后（类似于压缩的方法），实际代码才首次被暴露——希望是在安全机制允许其通过之后，并在解密后立即执行。

#### 2.1.4 白名单绕过 (_Whitelist Bypass_)

        白名单技术利用了一个受信任的模型，用于识别在给定系统上曾经出现过的应用程序。该技术对系统进行基线检查，识别出哪些是正常运行的程序，哪些是外来的。渗透测试者应该能够绕过白名单技术。最常见的方法之一是通过直接内存访问。白名单无法实时监控内存，如果一个内存驻留的程序正在运行且不接触磁盘，它可以在不被检测的情况下运行。

#### 2.1.5 进程注入 (_Process Injection_)

        进程注入是指向已运行的进程中注入代码的方法。通过注入进程，应用程序的信息可以隐藏在一个通常被信任的进程中。预防措施技术很难检查正在运行的进程，几乎总是可以隐藏在应用程序认为可信的另一个进程中。

#### 2.1.6 内存驻留 (_Purely Memory Resident_)

        内存驻留攻击通常是最受欢迎的，因为大多数技术不会检查内存。作为攻击者，找到一种纯粹驻留在内存中的方法是最理想的。当写入磁盘时，大多数应用程序会进行扫描、基线检查和其他潜在恶意软件的识别。当写入磁盘时，被检测到的可能性会显著增加。

### 2.2 人为因素 (_Human_)

        在执行利用时，并不总是通过直接漏洞或应用程序缺陷是最佳路线。有时，人为因素可能是攻击组织的更好方法。了解正确的攻击途径并确保我们使用的方法是最佳路线是很重要的。

### 2.3 数据执行保护 (DEP) (_Data Execution Prevention (DEP)_)

        在进行漏洞利用时，许多预防措施可能会发挥作用。数据执行保护是一种在大多数操作系统中实现的防御措施，当内存被重写时，会阻止执行权限。DEP 背后的思路是阻止攻击者重写内存后执行代码。尽管如此，仍然有多种方法可以绕过数据执行保护，这些方法会在PTES的利用阶段进行讨论。

### 2.4 地址空间布局随机化 (_Address Space Layout Randomization_)

        在发生缓冲区溢出漏洞时（或任何我们可以控制内存的情况），内存地址通常是硬编码的，以便将执行流重定向到我们的shellcode。在ASLR的情况下，某些字节会被随机化，以防止攻击者预测可以总是跳转到哪里去执行shellcode。

### 2.5 Web应用防火墙 (WAF) (_Web Application Firewall (WAF)_)

        Web应用防火墙是一种技术，位于应用程序内联，以保护其免受基于Web的应用攻击。Web应用防火墙试图识别并阻止针对特定Web应用程序的潜在危险或畸形攻击。在渗透测试期间，应测试绕过Web应用防火墙的多种技术。

## 3 规避 (_Evasion_)

        规避是在渗透测试期间使用的一种逃避检测的技术。这可能包括规避摄像系统以避免被保安看到，混淆负载以躲避入侵检测系统（IDS）或入侵防御系统（IPS），或对请求/响应进行编码以绕过Web应用防火墙。总的来说，在利用之前需要形成一种低风险的规避技术或人员的情况。

## 4 精确打击 (_Precision Strike_)

        渗透测试的主要目标是模拟攻击者，以代表对组织的模拟攻击。渗透测试带来的价值通常不在于噪声很大的攻击，如使用所有漏洞利用尝试攻击。这种方法在渗透测试结束时可能特别有用，以评估组织的事件响应水平，但在大多数情况下，利用阶段是对目标进行具体研究的积累。

## 5 定制化利用途径 (_Customized Exploitation Avenue_)

        每次攻击在利用途径的发生方式上通常不会相同。为了在这个阶段取得成功，攻击应根据场景进行定制和调整。例如，如果进行无线渗透测试，并使用了特定的技术，需要根据所使用的技术进行识别和攻击。对每种场景和漏洞利用的适用性有清晰的理解是渗透测试这个阶段最重要的方面之一。

## 6 定制化漏洞利用 (_Tailored Exploits_)

        在许多情况下，互联网上公开的漏洞利用可能需要进行一些调整才能成功执行。在大多数情况下，如果一个漏洞利用是为Windows XP SP2设计的，那么为了使攻击在Windows XP SP3上成功，就需要对漏洞利用进行特定的修改。渗透测试人员应具备定制漏洞利用的知识，并能够灵活修改以成功完成攻击。

### 6.1 漏洞利用定制 (_Exploit Customization_)

        在攻击中，通常需要模拟受害者的基础设施，以确保利用阶段能够成功。信息收集阶段采用的技术可以提供帮助，但拥有一个有效的基础设施和系统将使利用阶段更加容易。在定制化漏洞利用的情况下，渗透测试人员应该能够定制已有的公开漏洞，以成功攻击系统。漏洞利用的常见主题是针对特定版本的操作系统或应用程序。其原因在于内存地址会根据服务包和/或新版本的操作系统而变化。测试人员应能够定制这些漏洞利用，以成功部署到不同的操作系统并成功攻陷系统。

## 7 零日角度 (_Zero-Day Angle_)

        在大多数情况下，零日漏洞角度通常是渗透测试人员的最后手段。这种类型的攻击通常代表一个能够通过常规攻击方法针对组织进行集中攻击的高度先进的组织。在某些情况下，可能会进行研究以逆向工程、模糊测试或执行未被发现的漏洞的高级发现。如果这种类型的攻击适用，请确保尽可能重现攻击者所了解的环境，包括对策技术。

        为了使零日漏洞利用成功（或任何漏洞利用），拥有相同的操作系统、补丁和对策对成功至关重要。有时，根据已获得的访问级别或枚举，可能无法获取这些信息。

### 7.1 模糊测试 (_Fuzzing_)

        模糊测试是重新创建协议或应用程序并尝试向应用程序发送数据以希望识别漏洞的能力。模糊测试器通常希望识别应用程序中的崩溃并据此制作特定的漏洞利用。在模糊测试中，攻击者试图从未被发现的地方创建特定的漏洞。作为渗透测试的一部分，如果在参与过程中未识别出任何途径，或参与要求进行零日研究；应利用模糊测试技术来识别潜在的易受攻击的暴露点。

### 7.2 源代码分析 (_Source Code Analysis_)

        渗透测试人员可以利用的其他途径是源代码是否可用或开源。如果测试人员有能力查看源代码并识别应用程序中的缺陷，也可以通过这些方法识别零日暴露。

### 7.3 漏洞类型 (_Types of Exploits_)

        在渗透测试期间可以识别出几种类型的漏洞利用，这些漏洞利用可以被归类为零日漏洞。其中一些在本节中列出。

#### 7.3.1 缓冲区溢出 (_Buffer Overflows_)

        缓冲区溢出是由于不正确的编码技术造成的。具体来说，这通常发生在程序将数据写入缓冲区，然后超出缓冲区的边界并开始覆盖内存的部分时。在缓冲区溢出漏洞利用中，攻击者的目标是控制崩溃并在给定系统上获得代码执行。在缓冲区溢出漏洞利用中，更常见的技术之一是覆盖给定的寄存器并“跳转”到shellcode。

#### 7.3.2 SEH覆盖 (_SEH Overwrites_)

        SEH（结构化异常处理 Structured Exception Handling）重写发生在结构化异常处理程序开始正常关闭应用程序时。攻击者可以操控SEH的工作方式，重写SEH处理程序的基地址，并通过SEH获得执行流的控制。这是利用缓冲区溢出漏洞和编译了SEH的应用程序时常用的攻击。

#### 7.3.3 返回导向编程 (_Return Oriented Programming_)

        返回导向编程是一种技术，通常在用户可以控制执行流但存在数据执行保护（DEP）或其他防御机制的情况下使用。当 DEP 启用时，攻击者无法直接执行特定的汇编指令，因此攻击者会构建 ROP 小程序（ROP gadget），以准备调用某些 Windows API 或技术来禁用或绕过 DEP。一种常见的方法是利用 WriteProcessMemory 调用，将数据从堆栈复制到可写的内存空间，然后再执行这些数据。

### 7.4 流量分析 (_Traffic Analysis_)

        流量分析是一种识别所发送信息类型并理解和操控该流量的技术。渗透测试人员应能够理解协议的工作原理，并了解如何操控协议以进行攻击。

### 7.5 物理访问 (_Physical Access_)

        在渗透测试中，物理访问可以是一种有效的攻击方法，用于尝试绕过物理安全控制并获得未经授权的访问。在渗透测试中，评估人员应能够识别潜在有缺陷的物理安全控制，并在测试范围内尝试进入设施。

#### 7.5.1 人为因素 (_Human Angle_)

        在物理渗透测试中，一些最明显的方法是通过社会工程手段进入设施并获得访问权限。这需要对组织的业务运作方式有深入了解，以及从情报收集阶段所获得的一切信息。

#### 7.5.2 电脑访问 (_PC Access_)

        如果获得对 PC 的物理访问权限，渗透测试人员应能够通过多种方法攻击 PC 并获得系统访问权限。

### 7.6 近距离访问 (WiFi) (_Proximity Access (WiFi)_)

        无线通信是一种通过射频（RF）类型通信进行攻击以获得访问权限的途径。渗透测试人员应查看 FCC 的射频列表，以确定目标是否注册了正在使用的频谱频率。

#### 7.6.1 WiFi攻击 (_WiFi Attacks_)

        无论协议如何，都可以对 WEP、WPA、WPA2、EAP-FAST、EAP-LEAP 等进行多种攻击。攻击者应熟悉各种加密协议和标准，并能够有效地测试所实施的安全控制措施。

#### 7.6.2 攻击用户 (_Attacking the User_)

        利用恶意接入点（rogue access points）来攻击受害者通常是一种有效且可行的攻击方法。在无线评估期间，应该利用恶意接入点引诱受害者，从而进行漏洞利用或窃取敏感信息。有几种常见技术可以使用，其中最常见的是攻击者设置一个具有相同名称或诱人名称的无线接入点，以便受害者连接。

## 8 攻击实例途径 (_Example Avenues of Attack_)

        在任何场景中，攻击应基于在测试范围内的具体情境进行设计。以下是基于不同场景可考虑的几种攻击途径，但这绝不是详尽的列表。

- Web应用攻击
- 社会工程
- 物理攻击途径
- 基于内存的漏洞利用（如：缓冲区/堆溢出、内存损坏、重用后释放漏洞）
- 中间人攻击
- VLAN 跳跃
- USB/闪存驱动器部署
- 逆向工程
- 零日漏洞角度
- 攻击用户
- 加密破解
- 图形处理单元（GPU）破解
- 流量分析
- Firewire
- 路由协议
- 带有预设情境的网络钓鱼
- 冒充员工

        再次强调，这些例子只是基于您为组织执行的场景的基本攻击途径。渗透测试的价值在于创造力，以及识别漏洞并精确利用它们的能力。

## 9 总体目标 (_Overall Objective_)

        在与客户的预测试互动阶段，应清晰地定义渗透测试的总体目标。在利用阶段，最大的挑战是识别进入组织的最小阻力路径，同时不被检测到，并对组织的收入产生最大影响。

        通过正确地执行前期阶段，应对组织的运作方式和盈利方式有一个清晰的理解。从利用阶段到后利用阶段，攻击向量应完全依赖于绕过安全控制的任务，以展示针对组织的定向攻击如何导致组织遭受重大损失。

[主页](./../README.md)        [上一页](./Vulnerability_Analysis.md)        [下一页](./Post_Exploitation.md)
