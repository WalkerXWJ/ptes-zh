[返回主页](./../README.md)        [上一页](./pre-engagement.md)        [下一页]()

# 阶段 2 情报收集（Intelligence Gathering）

## 1 一般 (General)

        本节定义了渗透测试中的情报收集活动。本文档旨在为进行目标侦察的渗透测试人员提供一个专门设计的标准，通常适用于企业、军事或相关领域的目标。文档详细描述了渗透测试侦察的思考过程和目标，并在正确使用时，帮助读者制定针对目标的高效战略计划。

### 1.1 背景概念 (Background Concepts)

        在本文件及PTES整体框架中，层级是一个重要的概念。它可以视为渗透测试的一种成熟度模型。定义层级能够帮助我们明确在特定现实条件下（如时间、精力、信息获取等）所期望的输出和活动。

        情报收集的层级目前分为三个类别，每个类别都给出了一个典型示例。这些示例应指导后续文档中技术的添加。例如，像创建Facebook个人资料并分析目标的社交网络这样的一项深入活动适用于更高级的案例，并应标记相应的层级。请参见下方的思维导图以获取示例。

#### 1.1.1 一级信息收集 (Level 1 Information Gathering)

        （思考：合规驱动）这是一个简单的点击式信息收集过程，几乎完全依赖自动化工具获取信息。满足进行渗透测试（PT）所需的最低要求。

        例如，Acme Corporation需要遵循PCI/FISMA/HIPAA等合规性标准。在这种情况下，级别 1 的信息收集工作即可满足其合规要求。

#### 1.1.2 二级信息收集 (Level 2 Information Gathering)

        思考：最佳实践）这一层次结合了级别 1 的自动化工具和一些手动分析。需要对业务有较深入的了解，包括物理位置、业务关系、组织结构等信息。

        例如，Widgets Inc需要遵循PCI合规性，同时对长期安全策略非常关注，正在收购几家较小的部件制造商。级别 2 的信息收集工作能够满足他们的需求

#### 1.1.3 三级信息收集 (Level 3 Information Gathering)

        （思考：国家赞助）这是更为复杂的渗透测试，包括红队和全范围测试。涉及级别 1 和级别 2 的所有信息以及大量的手动分析。此级别需要在社交网络上建立关系，进行深入分析，深刻理解业务关系，通常需花费大量时间进行信息收集和关联。

        例如，一支军队红队负责分析和攻击驻外某国军队网络的特定部分，以寻找可能被外国人利用的弱点。在这种情况下，级别 3 的信息收集工作是非常合适的。

## 2 情报收集 (Intelligence Gathering)

### 2.1 情报收集是什么 (What it is)

        情报收集是针对目标进行侦察，以尽可能多地收集信息，这些信息将在漏洞评估和利用阶段用于渗透目标。在这一阶段收集的信息越丰富，将来可使用的攻击向量就越多。

        开源情报（OSINT）是一种情报收集管理方法，旨在从公开可获得的资源中查找、选择和获取信息，并对其进行分析，以生成可操作的情报。

### 2.2 为什么要进行情报收集 (Why do it)

        我们进行开源情报收集是为了识别组织内部的各种切入点，这些切入点可以是物理的、电子的或人际的。许多公司常常忽视他们公开发布的信息，以及这些信息可能被有心攻击者利用。此外，许多员工也未充分意识到他们在公共平台上分享的个人信息，以及这些信息如何可能被用来攻击他们或他们的雇主。

### 2.3 情报收集并非总是有效的 (What is it not)

        开源情报（OSINT）可能不准确或不及时。信息来源可能被故意或意外地操纵，从而反映出错误的数据，随着时间的推移，信息可能变得过时，或者信息本身可能是不完整的。

        开源情报不包括翻找垃圾或任何从现场发现的物理物品中获取公司信息的方法。

## 3 目标选择 (Target Selection)

### 3.1 目标的识别和命名 (Identification and Naming of Target)

        在接近目标组织时，理解一家公司可能拥有多个不同的顶级域名（TLD）和附属业务是至关重要的。虽然这些信息应该在范围确定阶段就被收集，但在预参与阶段讨论时，发现额外的服务器、域名和公司并不罕见。例如，一家公司可能拥有一个 .com 的顶级域名，同时也可能拥有 .net、.co 和 .xxx。这些可能需要纳入修订后的测试范围，或者可能被限制在外。无论如何，在测试开始之前，都需要与客户确认这些信息。

### 3.2 考虑任何参与规则限制 (Consider any Rules of Engagement limitations)

        此时，回顾参与规则是一个好主意。这些规则在测试过程中常常会被忽视。作为测试人员，有时我们会过于专注于所发现的内容和潜在的攻击方式，以至于忘记哪些 IP 地址、域名和网络是可以攻击的。始终参考参与规则以保持测试的聚焦，这不仅从法律角度上至关重要，也有助于防止范围蔓延。每次偏离测试的核心目标都会浪费时间，而从长远来看，这可能会影响公司的经济效益。

### 3.3 考虑测试的时间长度 (Consider time length for test)

        整个测试的时间长度将直接影响情报收集的深度和广度。在某些测试中，整体周期可能长达两到三个月。在这种情况下，测试公司会投入大量时间研究公司的每个核心业务单元及其人员。然而，对于较短的“水晶箱”风格的测试，目标通常更加具体。例如，测试一个特定的网络应用程序可能不需要对公司首席执行官的财务记录进行深入研究。

### 3.4 考虑测试的最终目标 (Consider end goal of the test)

        每个测试都有明确的最终目标——组织认为关键的特定资产或过程。在情报收集阶段，确保包括所有相关的次要和三级元素是重要的。这些元素可以包括支持技术、第三方以及相关人员等。确保集中关注关键资产，有助于将较少相关的情报元素降级处理，并将其分类，以避免干扰分析过程。

## 4 开放源信息 (OSINT)

        **开源情报（OSINT）有三种形式：被动、半被动和主动。**

        **被动信息收集：** 被动信息收集通常只有在对信息收集活动有非常明确的要求，即绝不能被目标发现时，才有用。这种类型的分析在技术上较为困难，因为我们不会向目标组织发送任何流量，无论是来自我们自己的主机，还是来自互联网上的“匿名”主机或服务。这意味着我们只能使用和收集存档或存储的信息。因此，这些信息可能过时或不准确，因为我们只能依赖第三方收集的结果。

        **半被动信息收集：** 半被动信息收集的目标是使用看起来像正常互联网流量和行为的方法对目标进行分析。我们仅查询已发布的名称服务器获取信息，不进行深入的反向查找或暴力 DNS 请求，也不搜索“未发布”的服务器或目录。我们不进行网络级端口扫描或爬虫，只查看已发布文档和文件中的元数据，而不是主动寻找隐藏内容。关键在于不引起对我们活动的注意。在事后，目标可能能够追溯到侦查活动，但他们不应该能够将这些活动归因于任何人。

        **主动信息收集：** 主动信息收集应该被目标检测到，且表现出可疑或恶意的行为。在这一阶段，我们主动映射网络基础设施（例如，使用 nmap 进行全端口扫描），主动枚举和/或对开放服务进行漏洞扫描，积极搜索未发布的目录、文件和服务器。大多数此类活动属于典型的“侦查”或“扫描”活动，这也是标准渗透测试的一部分。

### 4.1 企业 (Corporate)

#### 4.1.1 物理 (Physical)

##### 4.1.1.1 位置 (Locations) (L1)

        每个位置需列出完整地址、所有权、相关记录（城市、税务、法律等），以及该位置的所有物理安全措施的详细列表（监控摄像头位置、传感器、围栏、警卫岗位、出入口控制、门禁、身份识别类型、供应商入口、基于 IP 块/地理位置服务的物理位置等）。对于主机/NOC：完整的主机和网络的 CIDR 表示法、所有相关资产的完整 DNS 列表、AS 完整映射、对等路径、CDN 配置、网络块所有者（whois 数据）、电子邮件记录（MX + 邮件地址结构）。

- 所有者（L1/L2）

- 土地/税务记录（L1/L2）  

- 共享/个体（L1/L2）  

- 时区（L1/L2）  

- 主机/NOC

##### 4.1.1.2 普及性 (Pervasiveness) (L1)

        目标组织通常有多个独立的物理位置。例如，一个银行会有中央办公室，但也会有许多远程分支机构。虽然中央位置的物理和技术安全可能非常好，但远程位置的安全控制往往较差。

##### 4.1.1.3 关系 (Relationships) (L1)

        业务合作伙伴、客户、供应商，通过企业网页上公开分享的信息进行分析、租赁公司等。这些信息可以帮助更好地理解业务或组织项目。例如，哪些产品和服务对目标组织至关重要？

此外，这些信息也可以用于创建成功的社会工程场景。

- 关系（L2/L3）
  
  - 手动分析以验证一级信息，并深入挖掘可能的关系。 

- 共享办公空间（L2/L3） 

- 共享基础设施（L2/L3）  

- 租赁/租用设备（L2/L3）

#### 4.1.2 逻辑 (Logical)

**累积信息用于合作伙伴、客户和竞争对手**：对于每个类别，提供完整的商业名称、商业地址、关系类型、基本财务信息以及基本主机/网络信息。

- **商业合作伙伴 (L1/L2/L3)** 
  
  目标公司的广告合作伙伴，有时会在官方网站上展示。

- **商业客户 (L1/L2/L3)**  
  目标公司的广告客户，有时会在官方网站上展示。

- **竞争对手 (L1/L2/L3)**  
  目标公司的竞争对手，这可能很简单（例如，福特与雪佛兰），也可能需要更深入的分析。

- **触图 (L1)**  
  触图是社交关系的可视化表示，有助于映射组织内部人员之间的互动，以及如何从外部接触他们（当触图包括外部社区且深度级别超过2时）。基本触图应反映已收集信息所形成的组织结构，进一步扩展应基于此（因为它通常更好地代表组织资产的焦点，并使潜在接触路径清晰可见）。

- **Hoovers 资料 (L1/L2)**  
  **什么**：一种半开放的情报资源（通常需付费订阅），专门收集公司相关信息，并提供标准化的商业视图。  
  **为什么**：信息包括物理位置、竞争格局、关键人员、财务信息及其他商业相关数据（视来源而定）。这些信息可以用于创建更准确的目标公司资料，并识别其他人员和第三方以便于测试。  
  **如何**：在网站上简单搜索公司名称即可获取公司完整资料及可用信息。建议使用多个来源进行交叉验证，以确保获取最新信息（通常为付费服务）。

- **产品线 (L2/L3)**  
  目标公司的产品和服务提供情况，可能需要进一步分析。

- **市场垂直 (L1)**  
  目标公司所在行业，例如金融、国防、农业、政府等。

- **营销账户 (L2/L3)**  
  营销活动提供丰富的信息，帮助分析目标的营销策略，包括评估目标在社交媒体网络上的表现以及过去的营销活动。

- **会议 (L2/L3)**  
  会议纪要是否公开？  
  会议是否向公众开放？

- **重要公司日期 (L1/L2/L3)**
  
  - 董事会会议
  
  - 节假日
  
  - 周年纪念
  
  - 产品/服务发布

- **职位空缺 (L1/L2)**  
  查看组织的职位空缺列表（通常在官网的“招聘”部分）可以揭示其使用的技术类型。例如，若有高级Solaris系统管理员的招聘，说明该组织在使用Solaris系统。其他职位的技术需求可能不那么明显，但如招聘初级网络管理员时提到“优先考虑CCNA”或“优先考虑JNCIA”，则表明使用Cisco或Juniper技术。

- **慈善关系 (L1/L2/L3)**  
  目标组织高管通常与慈善组织有关联，此信息可用于制定有效的社会工程策略。

- **RFP、RFQ及其他公开招标信息 (L1/L2)**  
  RFP和RFQ通常揭示公司所用系统的类型及基础设施中的潜在问题，了解当前招标获胜者可能揭示所用系统或公司资源的外部托管位置。

- **法院记录 (L2/L3)**  
  法院记录通常可免费获取，或需支付费用。这些记录的内容可以揭示关于过去投诉者的信息，包括前雇员的诉讼情况。当前及前员工的刑事记录可能提供社会工程目标的线索。

- **政治捐款 (L2/L3)**  
  绘制政治捐款或其他财务利益的图谱，有助于识别那些并不在明显权力位置但却拥有重要利益的个人。政治捐款情况因国家而异，信息自由的程度不同，但往往可以通过可用数据追踪来自其他国家的捐款。

- **专业许可及注册 (L2/L3)**  
  收集目标公司的专业许可和注册信息，有助于了解其运营方式及遵循的规章制度。例如，公司的ISO标准认证表明其遵循特定的指南和流程。了解这些流程及其对测试的影响，对测试人员尤为重要。
  
  公司通常会在官网上展示这些信息，作为信誉标志。在某些情况下，可能需查阅特定行业的注册信息，以确认公司是否为相关组织的成员。可用信息受行业及地理位置影响，国际公司可能因国家要求不同而拥有不同的许可和注册情况。

#### 4.1.3 组织结构图 (Org Chart) (L1)

- 职位识别
  - 组织内的重要人员
  - 具体目标个体
- 交易信息
  - 组织内变动的映射（晋升、横向调动）
- 关联公司
  - 与业务相关的关联组织映射

#### 4.1.4 电子 (Electronic)

##### 4.1.4.1 文档元数据 (Document Metadata) (L1/L2)

- **什么是元数据？**  
  元数据或元内容是关于特定数据/文档的信息。它可以包含诸如作者/创建者姓名、时间和日期、使用/引用的标准、计算机网络中的位置（如打印机、文件夹、目录路径等）、地理标记等信息。对于图像，元数据可能包含颜色、深度、分辨率、相机品牌/类型，甚至坐标和位置信息。

- **为什么要收集元数据？**  
  元数据非常重要，因为它包含关于内部网络、用户名、电子邮件地址、打印机位置等信息，有助于构建位置蓝图。此外，它还提供关于创建相关文档所使用软件的信息。这可以使攻击者基于网络和用户的内部知识来创建个人档案或执行针对性攻击。

- **如何提取元数据？**  
  有多种工具可用于提取文件（如pdf、Word、图像）中的元数据，例如FOCA（图形界面工具）、metagoofil（基于Python）、meta-extractor和exiftool（基于Perl）。这些工具能够提取并以不同格式（如HTML、XML、图形界面、JSON等）展示结果。这些工具的输入通常是从客户公共信息中下载的文档，随后进行分析以获取更多信息。FOCA可以通过其图形界面帮助用户搜索文档、下载和分析。

##### 4.1.4.2 市场营销 (Marketing Communications) (L1/L2)

- 过去的市场营销活动提供了可能已经终止但仍可访问的项目的信息。
- 当前的市场传播包含设计元素（如颜色、字体、图形等），这些元素在内部使用较为普遍。
- 额外的联系信息包括外部市场营销组织的信息。

#### 4.1.5 基础设施资产 (Infrastructure Assets)

##### 4.1.5.1 拥有的网络块 (Network blocks owned) (L1)

- 组织拥有的网络区块可以通过whois查询被动获取。DNSStuff.com是获取此类信息的一站式平台。  

- 对IP地址进行开源搜索可以提供有关目标基础设施类型的信息。管理员常常在各种支持网站上发布与帮助请求相关的IP地址信息。

##### 4.1.5.2 电子邮件地址 (Email addresses) (L1)

- 电子邮件地址可以提供有效用户名和域结构的潜在列表。  

- 这些电子邮件地址可以从多个来源收集，包括组织的官方网站。

##### 4.1.5.3 外部基础设施概况 (External infrastructure profile) (L1)

- 目标的外部基础设施概况能够提供大量关于内部使用技术的信息。  

- 这些信息可以通过多种方式被动或主动收集。  

- 在构建针对外部基础设施的攻击场景时，应充分利用该概况。

##### 4.1.5.4 使用的技术 (Technologies used) (L1/L2)

- 通过支持论坛、邮件列表和其他资源进行的OSINT搜索可以收集目标所使用技术的信息。  

- 可以对已识别的信息技术组织实施社会工程学攻击。  

- 也可以针对产品供应商进行社会工程学攻击。

##### 4.1.5.5 采购协议 (Purchase agreements) (L1/L2/L3)

- 采购协议包含有关目标处的硬件、软件、许可证及其他有形资产的信息。

##### 4.1.5.6 远程访问 (Remote access) (L1/L2)

- 获取员工和/或客户如何连接到目标进行远程访问的信息提供了潜在的进入点。  

- 通常，远程访问门户的链接可在目标的主页上找到。  

- “使用手册”文档展示了远程用户连接所需的应用程序和流程

##### 4.1.5.7 应用程序使用情况 (Application usage) (L1/L2)

- 收集目标组织使用的已知应用程序列表。这通常可以通过提取公开可访问文件中的元数据来实现（如前面所述）。

##### 4.1.5.8 防御技术 (Defense technologies) (L1/L2/L3)

- 识别正在使用的防御技术可以通过多种方式进行，具体取决于所采用的防御措施。

###### 4.1.5.8.1 被动指纹识别 (Passive fingerprinting)

- 搜索论坛和公开信息，查找目标组织的技术人员可能讨论的问题或寻求帮助的内容。
- 查阅目标组织及知名技术供应商的市场营销资料。
- 使用Tin-eye（或其他图像匹配工具）搜索目标组织的标志，查看其是否出现在供应商的参考页面或宣传材料中。

###### 4.1.5.8.2 主动指纹识别 (Active fingerprinting)

- 向面向公众的系统发送适当的探测数据包，以测试阻断模式。针对特定WAF类型的指纹识别工具有多种可供使用。
- 从目标网站的响应以及电子邮件的头信息中，通常可以获得有关所使用系统和启用的特定保护机制（如电子邮件网关的反病毒扫描器）的信息

##### 4.1.5.9 人力能力 (Human capability) (L1/L2/L3)

了解目标组织的防御人力资源能力可能比较困难，但有几个关键信息可以帮助评估目标组织的安全性。

- 检查是否存在公司范围内的CERT（Computer Emergency Response Team计算机应急响应小组）/CSIRT（Computer Security Incident Response Team计算机安全事件响应小组）/PSRT（Product Security Response Team产品安全响应事件）团队。
- 查看招聘广告中安全职位的发布频率。
- 检查非安全职位（如开发人员）的招聘广告，看看是否将安全作为要求。
- 查阅外包协议，了解目标的安全性是否部分或完全外包。
- 查找公司内活跃于安全社区的特定人员。

#### 4.1.6 财务 (Financial)

##### 4.1.6.1 报告 (Reporting) (L1/L2)

        目标的财务报告将很大程度上取决于组织的所在地。报告也可能通过组织的总部进行，而不是针对每个分支机构进行报告。2008年，美国证券交易委员会（SEC）发布了一份关于在美国采用国际财务报告准则（IFRS）的提议路线图。

        各国IFRS采用情况 --> [Use of IFRS Accounting Standards by jurisdiction](http://www.iasplus.com/en/resources/use-of-ifrs)

##### 4.1.6.2 市场分析 (Market analysis) (L1/L2/L3)

        从分析机构（如Gartner、IDC、Forrester等）获取市场分析报告，包括市场定义、市场规模、竞争对手，以及对估值、产品或公司整体的重大变化。

###### 4.1.6.2.1 贸易资本 (Trade capital)

        确定组织是否分配了任何贸易资本，以及其在整体估值和可用资本中所占的百分比。这将表明组织对市场波动的敏感性，以及其是否依赖外部投资作为估值和现金流的一部分。

###### 4.1.6.2.2 价值历史 (Value history)

对组织的估值进行时间序列图表分析，以建立外部和内部事件之间的相关性，以及它们对估值的影响。

###### 4.1.6.2.3 EDGAR (SEC)

        什么是它：EDGAR（电子数据收集、分析和检索系统）是美国证券交易委员会（SEC）的一种数据库，包含所有依法必须提交的公司（包括外国和国内公司）的注册声明、定期报告及其他信息。  
        为什么要这样做：EDGAR 数据非常重要，因为除了财务信息外，它还能识别公司内的关键人员，这些人员在公司官网或其他公开渠道上可能并不显著。此外，它还包括高管薪酬声明、主要普通股东的姓名和地址、针对公司的法律诉讼摘要、经济风险因素及其他潜在有趣的数据。

        如何获取：这些信息可以在SEC的EDGAR网站[http://www.sec.gov/edgar.shtml](http://www.sec.gov/edgar.shtml)上获取。

### 4.2 个人 (Individual)

#### 4.2.1 员工 (Employee)

##### 4.2.1.1 历史 (History)

- 法院记录 (L2/L3)  
  
  - 什么是它：法院记录是与刑事和/或民事投诉、诉讼或针对个人或组织的其他法律行动相关的所有公共记录。  
  
  - 为什么要这样做：法院记录可能揭示与特定员工或整个公司相关的敏感信息。这些信息本身可能具有价值，或者可能成为获取其他信息的切入点。此外，这些信息还可以用于社交工程或在渗透测试中的其他用途。  
  
  - 如何获取：许多信息现在可以通过公开的法院网站和记录数据库在线获取。某些额外信息可能通过付费服务（如LEXIS/NEXIS）获得。还可以通过信息请求或亲自申请来获取部分信息。

- 政治捐赠 (L2/L3)  
  
  - 什么是它：政治捐赠是个人的私人资金，用于支持特定政治候选人、政党或特殊利益组织。  
  
  - 为什么要这样做：关于政治捐赠的信息可能揭示与个人相关的有用信息。这些信息可用于社交网络分析，帮助建立个人与政治人物、候选人或其他政治组织之间的联系。同时，这些信息也可以用于社交工程或在渗透测试中的其他目的。  
  
  - 如何获取：大部分信息可以通过公开网站（如：[http://www.opensecrets.org/](http://www.opensecrets.org/)）在线获取，这些网站跟踪个人的政治捐赠。根据不同州的法律，超过一定金额的捐赠通常需要记录。

- 专业执照或登记 (L2/L3)  
  
  - 什么是它：专业执照或登记是包含获得特定执照或在某一社区内具有特定关联的个人成员及其他相关信息的资料库。  
  
  - 为什么要这样做：关于专业执照的信息可能揭示与个人相关的有用信息。这些信息可用于验证个人的可信度（如其是否确实拥有所声称的认证），或作为社交网络分析的一部分，帮助建立个人与其他组织之间的联系。同时，这些信息也可用于社交工程或在渗透测试中的其他用途。  
  
  - 如何获取：很多信息现在可以通过公开网站在互联网上获得。通常，每个组织会维护自己的信息登记，这些信息可能在线可用，或需要采取额外步骤进行收集。

##### 4.2.1.2 社交网络资料 (Social Network (SocNet) Profile)

- 元数据泄露 (L2/L3)  
  
  - 通过照片元数据进行位置识别。

- 语气 (L2/L3)  
  
  - 预期成果：主观识别交流中使用的语气——如攻击性、被动、吸引人、销售性、赞美、贬低、居高临下、傲慢、精英主义、弱者、领导者、追随者、模仿等。

- 频率 (L2/L3)  
  
  - 预期成果：识别发布的频率（每小时/每天/每周等）。此外，确定交流发生的时间（如一天中的时间或一周中的时间）。

- 位置识别 (L2/L3)  
  
  从各种来源绘制被分析对象的位置历史，无论是通过与应用程序和社交网络的直接互动，还是通过照片元数据的被动参与。  
  
  - Bing地图应用  
  
  - Foursquare  
  
  - Google Latitude  
  
  - Yelp  
  
  - Gowalla  

- 社交媒体存在 (L1/L2/L3)  
  
  - 验证目标的社交媒体账户/存在情况（L1），并提供详细分析（L2/L3）。

##### 4.2.1.3 网络身份 (Internet Presence)

- 电子邮件地址 (L1)  
  
  - 什么是它？电子邮件地址是用户的公共邮箱ID。  
  
  - 为什么要这样做？收集或搜索电子邮件地址很重要，因为它有多个用途——提供可能的用户ID格式，可以在后续的暴力破解中使用，但更重要的是，它有助于发送有针对性的垃圾邮件，甚至是自动化机器人。这些垃圾邮件可能包含漏洞、恶意软件等，并且可以针对特定用户用特定内容进行发送。  
  
  - 如何获取：电子邮件地址可以从各种网站、群组、博客、论坛、社交网络门户等进行搜索和提取。这些电子邮件地址也可以从各种技术支持网站获取。还有一些收集和爬虫工具可以用于搜索映射到特定域名的电子邮件地址（如果需要的话）。

- 个人昵称/网名 (L1)  

- 注册的个人域名 (L1/L2)  

- 分配的静态IP/网络块 (L1/L2)

##### 4.2.1.4 物理位置 (Physical Location)

- 物理位置  
  
  - 你能获得目标的物理位置吗？

##### 4.2.1.5 移动足迹 (Mobile Footprint)

- 电话号码 (L1/L2/L3)  

- 设备类型 (L1/L2/L3)  

- 用途 (L1/L2/L3)  

- 已安装的应用程序 (L1/L2/L3)  

- 所有者/管理员 (L1/L2/L3)

##### 4.2.1.6 “付费”信息 (For Pay Information)

- 背景调查
- 付费LinkedIn
- LEXIS/NEXIS

## 5 隐秘收集 (Covert Gathering)

### 5.1 企业 (Corporate)

#### 5.1.1 现场收集 (On-Location Gathering)

选择特定地点进行现场收集，并在至少2-3天内进行侦察，以确保识别出规律。现场情报收集时关注以下要素：

- 物理安全检查
- 无线扫描 / 射频扫描
- 员工行为培训检查
- 可访问/相邻设施（共享空间）
- 垃圾箱清理
- 使用的设备类型

#### 5.1.2 离线收集 (Offsite Gathering)

识别离线地点及其与组织的关系和重要性，包括：

- 数据中心位置
- 网络供应商/提供商

### 5.2 人力情报 (HUMINT)

        人力情报补充了对资产的被动收集，因为它提供了无法通过其他方式获得的信息，并为情报全景增添了更多“个人”视角（如情感、历史、关键人物之间的关系、“氛围”等）。

        获取人力情报的方法总是涉及直接互动——无论是面对面还是口头交流。收集时应采用假身份，专门设计以实现最佳的信息曝光和与相关资产的合作。

此外，对更敏感目标的情报收集可以仅通过观察进行——可以是现场观察或通过电子/远程手段（如闭路电视、网络摄像头等）。

        这通常是为了建立行为模式（例如访客频率、着装规范、出入路径以及可能提供额外访问的关键地点，如咖啡店）。

#### 5.2.1 结果 (Results)

- 关键员工
- 合作伙伴/供应商
- 社会工程

## 6 信息收集 (Footprinting)

- **定义**：外部信息收集，也称为信息足迹分析，是信息收集的一个阶段，通过与目标的互动，从组织外部的角度获取信息。

- **目的**：通过与目标的互动，可以收集到大量信息。通过探测某项服务或设备，通常可以创建可以识别其指纹的场景，或者更简单地获取可以识别该设备的横幅。这个步骤对于获取更多关于目标的信息是必要的。在完成这一部分后，您的目标是生成一份优先级排序的目标列表。

### 6.1 外部信息收集 (External Footprinting)

#### 6.1.1 识别客户外部范围 (Identify Customer External Ranges)

        渗透测试期间情报收集的主要目标之一是确定将纳入评估范围的主机。有多种技术可以用来识别系统，包括使用反向DNS查找、DNS暴力破解、对域名和范围的WHOIS搜索等。以下记录了这些技术和其他方法。

#### 6.1.2 被动侦察 (Passive Reconnaissance)

##### 6.1.2.1 WHOIS 查询 (WHOIS Lookups)

对于外部信息足迹分析，首先需要确定哪个WHOIS服务器包含我们所需的信息。鉴于我们应该知道目标域的顶级域名（TLD），我们只需找到目标域注册的注册商。

WHOIS信息基于树形结构。ICANN（IANA）是所有顶级域的权威注册机构，是进行所有手动WHOIS查询的良好起点。

- ICANN - [http://www.icann.org](http://www.icann.org/)
- IANA - [http://www.iana.com](http://www.iana.com/)
- NRO - [http://www.nro.net](http://www.nro.net/)
- AFRINIC - [http://www.afrinic.net](http://www.afrinic.net/)
- APNIC - [http://www.apnic.net](http://www.apnic.net/)
- ARIN - [http://ws.arin.net](http://ws.arin.net/)
- LACNIC - [http://www.lacnic.net](http://www.lacnic.net/)
- RIPE - [http://www.ripe.net](http://www.ripe.net/)

一旦查询了适当的注册商，就可以获取注册人信息。有许多网站提供WHOIS信息；然而，为了确保文档的准确性，您需要仅使用适当的注册商。

- InterNIC - [http://www.internic.net/](http://www.internic.net/)

通常，对ARIN的简单WHOIS查询会引导您找到正确的注册商。

##### 6.1.2.2 BGP 查询 (BGP looking glasses)

可以识别参与边界网关协议（BGP）的网络的自治系统编号（ASN）。由于BGP路由路径在全球范围内被广播，我们可以通过使用BGP4和BGP6观察镜来找到这些信息。

- BGP4 - [http://www.bgp4.as/looking-glasses](http://www.bgp4.as/looking-glasses)
- BGP6 - [http://lg.he.net/](http://lg.he.net/)

#### 6.1.3 主动足迹识别 (Active Footprinting)

##### 6.1.3.1 端口扫描 (Port Scanning)

        端口扫描技术会根据测试的时间限制和隐蔽性需求而有所不同。如果对系统一无所知，可以使用快速的ping扫描来识别系统。此外，应运行不进行ping验证的快速扫描（在nmap中使用 -PN）以检测最常见的开放端口。完成此步骤后，可以进行更全面的扫描。一些测试人员仅检查开放的TCP端口，确保同时检查UDP端口。有关端口扫描类型的详细信息，请参见 http://nmap.org/nmap_doc.html 文档。Nmap（“网络映射器”）是网络审计/扫描的事实标准，支持在Linux和Windows上运行。

        有关Nmap在此目的上使用的更多信息，请参阅PTES技术指南。

        Nmap拥有数十种选项。由于本部分涉及端口扫描，我们将重点关注执行此任务所需的命令。需要注意的是，使用的命令主要取决于扫描的主机数量和时间。主机数量越多或时间越少，我们对主机的调查就会越少。随着我们继续讨论选项，这一点将变得更加明显。

        还应测试IPv6。

##### 6.1.3.2 横幅抓取 (Banner Grabbing)

        横幅抓取是一种枚举技术，用于获取网络上计算机系统的信息及其开放端口上运行的服务。横幅抓取用于识别目标主机运行的应用程序和操作系统的版本。

        横幅抓取通常在超文本传输协议（HTTP）、文件传输协议（FTP）和简单邮件传输协议（SMTP）上进行，分别对应端口80、21和25。常用的横幅抓取工具有Telnet、nmap和Netcat。

##### 6.1.3.3 **SNMP扫描** (SNMP Sweeps)

        SNMP扫描也会进行，因为它们可以提供关于特定系统的大量信息。SNMP协议是一个无状态的、数据报导向的协议。不幸的是，SNMP服务器不会对无效的社区字符串请求做出响应，并且底层UDP协议无法可靠地报告关闭的UDP端口。这意味着从被探测的IP地址“无响应”可能意味着以下任意一种情况：

- 机器无法到达
- SNMP服务器未运行
- 无效的社区字符串
- 响应数据报尚未到达

##### 6.1.3.4 区域传输 (Zone Transfers)

        DNS区域传输，也称为AXFR，是一种DNS事务。它用于在一组DNS服务器之间复制包含DNS数据的数据库。区域传输有两种类型：完整传输（AXFR）和增量传输（IXFR）。有多种工具可以测试执行DNS区域传输的能力，常用工具包括host、dig和nmap。

##### 6.1.3.5 SMTP 回弹 (SMTP Bounce Back)

        SMTP回弹，也称为非交付报告/收据（NDR）、（失败的）交付状态通知（DSN）消息、非交付通知（NDN）或简单地称为回弹，是邮件系统自动发送的电子邮件，通知发送者其邮件的交付问题。这种技术可以帮助攻击者识别SMTP服务器，因为回弹消息中可能包含有关SMTP服务器的信息，包括软件及其版本。

        攻击者可以通过在目标域内创建一个虚假的电子邮件地址来实现，例如使用asDFADSF_garbage_address@target.com来测试target.com。Gmail提供了完整的邮件头信息，因此是测试人员的一个便捷选择。

##### 6.1.3.6 DNS 发现 (DNS Discovery)

        DNS发现可以通过查看域的权威名称服务器的WHOIS记录来进行。此外，还应检查主域名的变体，并查看网站是否提到其他可能在目标控制下的域名。

##### 6.1.3.7 正向/反向 DNS (Forward/Reverse DNS)

        反向DNS可以用于获取组织内部使用的有效服务器名称。但需要注意的是，只有具备PTR（反向）DNS记录时，才能根据提供的IP地址解析出名称。如果能够解析，则会返回结果。通常是通过使用不同的IP地址测试服务器，查看是否返回任何结果来实现的。

##### 6.1.3.8 DNS 暴力破解 (DNS Bruteforce)

        在识别与客户域相关的所有信息后，可以开始查询DNS。由于DNS用于将IP地址映射到主机名，反之亦然，我们希望检查其是否配置不当。我们将尝试使用DNS揭示更多关于客户的信息。与DNS相关的最严重的错误配置之一是允许互联网用户执行DNS区域传输。我们可以使用多种工具来枚举DNS，不仅检查是否能够执行区域传输，还可能发现一些不常见的主机名。

##### 6.1.3.9 web应用发现 (Web Application Discovery)

        在渗透测试中，识别弱点Web应用程序是一项特别有成效的活动。应关注的内容包括配置错误的现成（OTS）应用程序、具有插件功能的OTS应用程序（插件通常包含比基础应用程序更脆弱的代码）以及自定义应用程序。Web应用指纹识别工具，如WAFP，能够在这方面发挥很大作用。

##### 6.1.3.10 虚拟主机检测与枚举 (Virtual Host Detection & Enumeration)

        Web服务器经常托管多个“虚拟”主机，以在单个服务器上整合功能。如果多个服务器指向同一DNS地址，它们可能托管在同一台服务器上。可以使用MSN搜索等工具将IP地址映射到一组虚拟主机。

#### 6.1.4 建立外部目标列表 (Establish External Target List)

        完成上述活动后，应编制一份包含用户、电子邮件、域名、应用程序、主机和服务的详细列表。

##### 6.1.4.1 映射版本 (Mapping versions)

        版本检查是一种快速识别应用程序信息的方法。利用nmap，可以对服务的版本进行指纹识别，同时通过查看任意页面的源代码，通常可以获取Web应用程序的版本信息。

##### 6.1.4.2 识别补丁级别 (Identifying patch levels)

        要识别内部服务的补丁级别，可以使用专门的软件询问系统，以发现不同版本之间的差异。在这一阶段，若客户同意，可以使用凭据进行测试。漏洞扫描器在远程识别补丁级别时尤其有效，且不需要凭据。

##### 6.1.4.3 寻找web应用的弱点 (Looking for weak web applications)

        在渗透测试中，识别Web应用程序的弱点是一项非常有成效的活动。应关注的方面包括配置不当的现成（OTS）应用程序、具有插件功能的OTS应用程序（因为插件通常包含比基础应用程序更脆弱的代码）以及自定义应用程序。Web应用指纹识别工具如WAFP在此方面非常有效。

##### 6.1.4.4 识别锁定阈值 (Identify lockout threshold)

        识别身份验证服务的锁定阈值可以确保在测试期间不会意外锁定有效用户。识别环境中所有不同的身份验证服务，并对一个单一的、无害的账户进行锁定测试。通常，对有效账户尝试5到10次就足以判断该服务是否会导致用户被锁定。

### 6.2 内部信息收集 (Internal Footprinting)

#### 6.2.1 被动侦察 (Passive Reconnaissance)

        如果测试人员能够访问内部网络，数据包嗅探可以提供大量信息。可以使用像p0f这类工具来识别系统。

#### 6.2.2 识别客户内部范围 (Identify Customer Internal Ranges)

        在进行内部测试时，首先需要枚举本地子网，通常可以通过轻微修改地址来推测其他子网的信息。此外，查看内部主机的路由表也常常能提供重要线索。以下是一些可以使用的技术：

        DHCP服务器不仅能提供本地信息，还可能包含远程IP范围及重要主机的详细信息。大多数DHCP服务器会提供本地IP网关地址，以及DNS和WINS服务器的地址。在基于Windows的网络中，DNS服务器往往是Active Directory域控制器，因此它们是重要的目标。

#### 6.2.3 主动侦察 (Active Reconnaissance)

内部主动侦察应包括外部侦察的所有元素，并特别关注内部网络的功能，例如：

- 目录服务（如Active Directory、Novell、Sun等）
- 提供业务功能的内联网网站
- 企业应用程序（如ERP、CRM、会计等）
- 敏感网络区段的识别（如会计、研发、市场等）
- 生产网络的访问映射（如数据中心）
- VoIP基础设施
- 身份验证管理（如Kerberos、Cookie令牌等）
- 代理服务和互联网访问管理

## 7 识别保护机制 (Identify Protection Mechanisms)

        以下元素应根据相关的位置、群体或人员进行识别和映射。这将确保在进行实际攻击时，能够正确应用漏洞研究和利用，从而最大化攻击效率并最小化被检测的概率。

### 7.1 网络层保护 (Network Based Protections)

- “简单”数据包过滤器
- 流量整形设备
- 数据丢失防护（DLP）系统
- 加密/隧道技术

### 7.2 主机层保护 (Host Based Protections)

- 堆栈/堆保护
- 应用程序白名单
- 杀毒软件/过滤/行为分析
- 数据丢失防护（DLP）系统

### 7.3 应用层保护 (Application Level Protections)

- 应用程序保护措施识别
- 编码选项
- 潜在绕过途径
- 白名单页面

### 7.4 存储保护 (Storage Protections)

- 主机总线适配器（HBA）
- LUN掩蔽
- 存储控制器
- iSCSI CHAP秘密

### 7.5 用户保护 (User Protections)

- 杀毒软件/垃圾邮件过滤软件
- 限制可被利用性的软件配置可视为反垃圾邮件/反杀毒软件措施

<hr>

[返回主页](./../README.md)        [上一页](./pre-engagement.md)      [下一页]()


