[主页](./../README.md)        [上一页](./Threat_Modeling.md)        [下一页](./Exploitation.md)

# 阶段 4 漏洞分析（*Vulnerability Analysis*）

## 1 测试（*Testing*）

        <span style="color:blue">漏洞测试</span>是识别系统和应用程序中可被攻击者利用的缺陷的过程。这些缺陷可能包括主机和服务的错误配置或不安全的应用程序设计。虽然寻找缺陷的具体方法各不相同，并且高度依赖于被测试组件的特性，但一些关键原则适用于整个过程。

        在进行任何类型的漏洞分析时，测试人员应合理界定测试的范围，以确保测试的深度和广度能够满足预期目标和要求。深度可以包括评估工具的位置、身份验证要求等。例如，在某些情况下，测试的目标可能是验证缓解措施是否有效且漏洞不可访问；而在其他情况下，目标可能是通过身份验证测试每个适用的变量，以发现所有相关的漏洞。无论测试范围如何，测试应根据深度要求进行调整，以实现既定目标。同时，测试的深度应始终得到验证，以确保评估结果符合预期（例如，所有机器是否都已通过身份验证等）。除了深度以外，进行漏洞测试时也必须考虑广度。广度可以包括目标网络、网络分段、主机、应用程序、资产清单等。在最简单的情况下，您的测试可能是查找主机系统上的所有漏洞；而在其他情况下，您可能需要查找特定资产清单或边界内所有主机的漏洞。此外，测试的广度也应始终得到验证，以确保您满足了测试的范围（例如，扫描时资产清单中的每台机器是否都是在线的？如果不是，是什么原因）。

## 2 主动测试(*Active*)

        主动测试是指直接与被测试组件进行交互，以识别安全漏洞。这可以涉及低层组件，例如网络设备上的TCP协议栈，也可以是更高层的组件，例如用于管理这些设备的基于Web的界面。与目标组件的交互主要有两种方式：自动化和手动。

### 2.1 自动化(*Automated*)

自动化测试利用软件与目标进行交互，分析响应，并依据这些响应判断是否存在漏洞。自动化过程可以显著减少时间和人力需求。例如，连接到系统上的单个TCP端口以检查其是否开放以接收数据相对简单，但如果手动对65,535个可能的端口逐一进行此操作，则耗时将非常长。当这种测试需要在多个网络地址上重复执行时，所需的时间可能过于庞大，因此需要某种形式的自动化。使用软件来完成这些操作可以让测试人员专注于数据处理和适合手动测试的任务。

#### 2.1.1 网络/通用漏洞扫描器(*Network/General Vulnerability Scanners*)

##### 2.1.1.1基于端口的扫描器(*Port Based*)

        自动化的基于端口的扫描通常是传统渗透测试的第一步，因为它提供了目标网络或主机上可能存在的服务的基本概况。基于端口的扫描器检查远程主机上的端口是否能够接收连接。通常，这涉及使用IP的协议（如TCP、UDP、ICMP等）。根据不同环境，其他网络协议上的端口也可能存在，例如在大型主机环境中，SNA(Systems Network Architecture)的使用相对常见。

        端口通常有两种状态：

- 开放：端口能够接收数据
- 关闭：端口无法接收数据

        如果扫描器无法准确判断某个端口是开放还是关闭，可能会标记为“过滤”状态。

        当扫描器确定某个端口开放时，通常会假设该端口可能存在漏洞。例如，如果基于端口的扫描器连接到TCP端口23，并且该端口在监听状态，扫描器很可能会报告该远程主机上提供了telnet服务，并标记为启用了明文身份验证协议。

##### 2.1.1.2基于服务的扫描器(*Service Based*)

        基于服务的漏洞扫描器利用特定协议与远程主机上开放的端口进行通信，以获取有关该端口上运行服务的更多信息。这种方法比仅依靠端口扫描更为精准，因为它不仅仅依赖端口来判断正在运行的服务。例如，端口扫描可以识别主机上的TCP端口8000是开放的，但仅凭这些信息无法确定运行的服务类型。服务扫描器会尝试使用不同的协议与该端口进行通信。如果在端口8000上运行的服务能够正确响应HTTP请求，那么它将被识别为Web服务器。

##### 2.1.1.3 横幅抓取（*Banner Grabbing*）

       <span style="color:blue">横幅抓取</span>是通过连接到特定端口并检查从远程主机返回的数据，以识别与该端口绑定的服务或应用程序的过程。在连接过程中，软件通常会提供一个标识字符串，其中可能包含应用程序的名称或运行的具体版本信息。

        这种技术常用于安全测试和网络扫描，以了解目标系统上运行的服务及其版本。通过获取这些信息，攻击者或安全测试人员可以评估潜在的安全漏洞。例如，了解某个服务的版本有助于判断该服务是否存在已知的安全漏洞，从而采取相应的防护措施。

#### 2.1.2 网页应用扫描器(*Web Application Scanners*)

##### 2.1.2.1 通用应用漏洞扫描器(*General application flaw scanners*)

        大多数网页应用扫描从网站、网页应用或网络服务的地址开始。扫描器随后会通过跟踪链接和目录结构来爬取整个网站。在编制出网页、资源、服务和其他提供的媒体的列表后，扫描器将对爬取结果进行测试或审计。例如，如果在爬取过程中发现的网页包含表单字段，扫描器可能会尝试进行SQL注入或跨站脚本攻击（XSS）。如果爬取的页面包含错误信息，扫描器可能会查找错误详情中显示的敏感信息，等等。

        需要注意的是，爬行和测试阶段可以交错进行，甚至同时进行，以减少整体扫描时间。这是许多网页应用扫描器的默认行为。

##### 2.1.2.2 目录列表/暴力破解(*Directory Listing/Brute Forcing*)

        假设网站上有一些目录，爬虫无法通过跟随链接找到。没有用户提供的这些目录的事先知识，扫描器至少有两个额外的选项。

        扫描器/爬虫可以搜索“常见”目录。这些是名称和名称变体的目录，通常会被找到，并且包含在经过多年经验和扫描编制的列表中。大多数网页应用都有这种“内置”列表，而一些渗透测试人员则维护自己的自定义列表。有时，目录名称足够独特，可以用来较高准确率地识别第三方网页应用。一个准确的目录列表通常是找到网站“管理”部分的关键，而这一部分是大多数渗透测试人员非常感兴趣的。

        暴力破解目录是一种类似的方法，不过不是使用静态列表，而是使用工具枚举目录名称可能的每种可能性。使用这种方法的缺点是，它有可能导致网页服务器崩溃或被大量请求淹没，从而引发拒绝服务（DoS）状态。因此，在进行目录暴力破解时，应谨慎行事，确保有人密切关注网页服务器的状态，尤其是在生产环境中。

作为渗透测试人员，您希望执行目录列出是为了扩展攻击范围，或寻找可能包含敏感信息的目录（根据渗透测试的目标，这可能会导致重大发现）。

Web服务器版本/漏洞识别

许多网页应用扫描器会尝试将Web服务器的版本与安全公告中已知的漏洞版本进行比较。这种方法有时会导致误报，因为在某些情况下，开源Web服务器可能会被分叉或复制，并赋予新的名称、横幅和不同的版本号。因此，应采取额外步骤以验证Web服务器实际运行的内容是否与横幅或Web扫描器报告的相符。

        **方法**

        有几种Web服务器方法被认为是不安全的，它们可能允许攻击者以不同程度的权限访问Web服务器内容。这些方法是Web服务器软件的一部分，而不是网站内容，这使得它们与迄今讨论的其他漏洞有所不同。一些不安全的方法包括：

        **OPTIONS**

        虽然HTTP OPTIONS方法本身并不不安全，但它可以让攻击者轻松枚举目标服务器接受的HTTP方法类型。需要注意的是，OPTIONS方法并不总是准确的，每种方法都应单独验证。

        **PUT/DELETE**

        使用PUT方法，攻击者可以上传恶意内容，如HTML页面，这些内容可以用于传输信息、更改网络内容或在Web服务器上安装恶意软件。通过DELETE方法，攻击者可能删除内容或篡改网站，导致服务中断。

        此外，现代REST应用以不同方式使用PUT方法：

        Create->POST Read->GET Update->PUT Delete->DELETE

       **WebDAV**

        WebDAV是Microsoft Internet Information Server (IIS)的一个组件。WebDAV代表“基于Web的分布式创作和版本控制”，用于编辑和文件管理。管理员使用WebDAV扩展在IIS Web服务器上远程管理和编辑Web内容，这些扩展包括PROPFIND、COPY、MOVE、PROPPATCH、MKCOL、LOCK和UNLOCK。WebDAV与核心操作系统组件进行交互，这可能会使系统暴露于多种潜在漏洞中。这些潜在风险包括：

- 由于不当处理用户请求导致的缓冲区溢出
- 由于格式错误请求导致的拒绝服务情况
- 基于域的脚本攻击
- 权限提升
- 执行任意代码

        **TRACE/TRACK**

        现代Web服务器支持TRACE HTTP方法，该方法包含一个可能导致未授权信息泄露的缺陷。TRACE方法用于调试Web服务器连接，允许客户端查看请求链对端接收到的内容。默认情况下，所有主要Web服务器都启用了该功能，远程攻击者可能会滥用HTTP TRACE功能以泄露敏感信息，从而导致机密性丧失。

#### 2.1.3 网络漏洞扫描器/特定协议(*Network Vulnerability Scanners/Specific Protocols*)

##### 2.1.3.1 VPN

        传统的漏洞评估工具无法与服务互联网密钥交换（IKE）的VPN设备进行正确的协议协商。在使用IKE的情况下，需要使用额外的工具包来执行诸如准确指纹识别、识别退避模式以及识别正在使用的身份验证机制等功能。通过识别VPN设备的这些属性，可以发现运行代码版本中的弱点以及身份验证类型，如静态预共享密钥。

##### 2.1.3.2 语音网络扫描器(*Voice Network Scanners*)

        **拨号攻击**

        许多组织仍使用通过电话线的带外访问。使用旨在进行拨号攻击的漏洞评估工具可以确定身份验证和网络架构中的弱点。

        **VoIP**

        大多数组织现在大量使用语音IP（VoIP）技术。已经开发了许多工具来对VoIP基础设施进行漏洞分析。使用这些工具，可以识别VoIP网络是否被正确分段，以及是否存在利用这些网络访问核心基础设施系统或记录目标网络上的电话对话的潜在可能性。

##### 2.1.3.3 手动直接连接(*Manual Direct Connections*)

        与任何自动化过程或技术一样，总会存在错误的可能性。系统、网络设备和网络连接中的不稳定性可能在测试期间引入不准确的结果。始终建议对目标系统上可用的每个协议或服务进行手动直接连接，以验证自动测试的结果，并识别所有潜在的攻击向量和先前未识别的弱点。

##### 2.1.3.4 混淆(*Obfuscated*)

        **多出口节点**

        安全监控和防御系统基于识别特定IP地址的恶意活动的前提进行操作。在部署了入侵检测系统并进行活动监控的情况下，从多个IP地址进行评估和攻击活动可以提供更准确的结果，并减少目标网络上的监控设备识别和响应的机会。诸如TOR代理等技术可以提供一种不从单一IP地址进行评估活动的方式。

        **IDS规避**

        在针对部署了IDS技术的目标环境进行评估活动时，可能需要执行规避。使用字符串操作、多态性、会话拼接和分片等方法可以在绕过IDS设备中实施的签名匹配模式的同时提供更准确的结果。

## 3 被动(*Passive*)

### 3.1 元数据分析(*Metadata Analysis*)

        元数据分析涉及查看描述文件的数据，而不是文件数据本身。例如，Microsoft Office文档可能列出文档作者、公司、文档最后保存的时间、创建时间等信息。许多文档甚至允许输入自定义元数据。这可能包含内部地址和服务器路径、内部IP地址以及渗透测试人员可以用来获取更多访问权限或信息的其他信息。

        尽管元数据在公司内部网络上的文档中很常见，但公司在将文档公开或在公共互联网发布之前，应注意清除元数据。因此，攻击者可以被动获取的任何元数据（无需直接攻击目标）应被视为安全问题。

### 3.2 流量监控(*Traffic Monitoring*)

        流量监控是连接到内部网络并捕获数据以进行离线分析的概念。在此阶段中排除路由投毒，因为它们在网络上产生“噪音”，并且很容易被检测到。通常令人惊讶的是，从“交换”网络中可以获取到多少敏感数据。这种在交换网络上“泄漏的数据”可以分类为以下几种情况：

        ARP/MAC缓存溢出，导致交换数据包被广播——这在ARP/MAC缓存计时配置不当的思科交换机上很常见。

        Etherleak——一些较旧的网络驱动程序和某些嵌入式驱动程序会使用系统内存中的数据来填充ARP数据包。如果能收集到足够多的ARP数据包，就可以捕获到来自内部内存的敏感信息。

        配置错误的集群或负载均衡器

        插入网络的集线器请注意，这些类别中有些仅导致数据泄漏到单一子网，而其他则可能导致更大网络段的数据泄漏。

## 4 验证(*Validation*)

### 4.1 工具之间的关联(*Correlation between Tools*)

        在使用多个工具时，发现的关联需求可能变得复杂。关联可以分为两种不同的风格：项目的具体关联和类别关联，二者都根据您试图在给定目标上收集的信息、指标和统计数据的类型而具有用处。

        具体关联涉及到具体确定的问题，如漏洞ID、CVE、OSVDB、供应商索引编号、软件产品已知问题等，并可与微观因素（如主机名、IP、FQDN、MAC地址等）进行分组。例如，通过CVE编号对主机x的发现进行分组，因为它们会在多个工具中索引相同的问题。

        类别关联涉及到问题的类别结构，如合规框架（即NIST SP 800-53、DoD 5300系列、PCI、HIPPA、OWASP列表等），这些框架允许您按宏观因素（如漏洞类型、配置问题等）对项目进行分组。例如，将默认密码的主机发现结果分组到NIST 800-53（IA-5）中的密码复杂性组中。

        在大多数情况下，渗透测试人员将重点放在通过对同一主机使用多个工具发现的具体漏洞的微观问题上。这种冗余可能会在测试输出中扭曲统计结果，导致风险概况虚高。

        相反，过度减少或简化宏观关联（如前10/20列表）可能会导致结果扭曲输出，导致风险概况虚低。

### 4.2 手动测试/协议特定(*Manual Testing/Protocol Specific*)

#### 4.2.1 VPN

        **指纹识别**

        指纹识别有助于确定VPN设备的类型和已安装的正确代码版本。通过准确地识别设备，可以针对目标系统进行适当的研究和分析。

        **身份验证**

        VPN设备可以通过多种形式进行身份验证。使用不属于传统漏洞评估工具的VPN工具包，可以正确识别身份验证机制，并确定可能存在的弱点，如预共享密钥或默认组ID。

#### 4.2.2 Citrix

        **枚举**

        许多默认安装和配置不当的Citrix设备提供了一种枚举已发布应用程序的方法，并确定配置为对设备进行身份验证的有效用户名。这些信息在暴力破解攻击和尝试突破授权用户的预定义配置文件时至关重要。

#### 4.2.3 DNS

        如果域名系统未得到适当的加固，可能会向攻击者提供大量信息。版本信息允许正确识别和准确的研究分析。诸如区域传输之类的弱点提供了一个详尽的攻击附加目标列表，以及可能涉及目标组织的敏感数据的信息泄漏。

#### 4.2.4 Web

        Web服务为攻击者提供了广阔的攻击面。与大多数其他协议和服务不同，Web服务通常在单个系统的多个端口上运行。管理员可能会将其加强重点放在Web服务或已发布目录的常用端口上，而忽视了对其他属性的适当加固。Web服务应始终以手动方式进行审查，因为自动评估工具无法识别其服务中的大多数弱点。

#### 4.2.5 邮件

    邮件服务器可以提供关于目标组织的大量信息。使用目标设备的固有功能，可以确认有效帐户，并制定其他系统攻击的潜在用户名列表。诸如邮件中继的漏洞可以用于对组织进行额外攻击，如网络钓鱼。通常，邮件服务器将提供一个可在暴力破解活动中作为目标的远程访问Web界面。

### 4.3攻击途径(*Attack Avenues*)

#### 4.3.1 创建攻击树(*Creation of attack trees*)

        在安全评估过程中，随着测试的逐步进行，创建攻击树对于最终报告的准确性至关重要。随着新系统、服务和潜在漏洞的识别，应该开发和定期更新攻击树。这在利用阶段尤为重要，因为一个实现的入口可能会在攻击树开发期间映射出的其他路径上重复。

#### 4.3.2 独立实验室测试(*Isolated Lab Testing*)

        当在独立实验室中设置复制环境时，漏洞分析和利用的准确性会大大提高。系统通常可能会通过特定的控制集或额外的保护机制加强。通过设计一个模仿目标组织的实验室，顾问可以确保识别出的漏洞和对目标的利用尝试是可靠的，从而减少不准确结果或系统无法操作的机会。

#### 4.3.3 视觉确认(*Visual Confirmation*)

        **手动连接与审查(*Manual Connection with Review*)**

        虽然适当的关联可以帮助减少错误发现并提高整体准确性，但目视检查目标系统是不可替代的。评估工具被设计用来查看协议/服务连接或响应的结果，并与已知的漏洞特征进行比较。然而，工具在识别非常规端口上的服务或应用程序中可能内置的自定义逻辑方面并不总是准确的。通过手动评估目标系统、其可用服务以及为这些服务提供功能的应用程序，测试人员可以确保已完成适当的验证和漏洞识别。

## 5 研究

### 5.1 公共研究

        一旦在目标系统中报告了漏洞，就需要确定问题识别的准确性，并研究在渗透测试范围内漏洞的潜在可利用性。在许多情况下，该漏洞将是商业或开源软件包中的已报告软件漏洞，而在其他情况下，漏洞可能是业务流程中的缺陷或常见的管理错误，如配置错误或默认密码使用。

#### 5.1.1 漏洞数据库(*Vulnerability Databases*)

        漏洞数据库可以用于验证自动化工具报告的问题，或手动审查目标应用程序的漏洞。大多数工具将使用CVE标识符来标识给定的漏洞，可以利用它访问CVE数据库中的摘要信息和其他来源的链接。CVE还可以用于在漏洞数据库（如OSVDB和Bugtraq）或漏洞利用数据库和框架中搜索问题。

        漏洞数据库应被用于验证报告问题的准确性。例如，Apache Web服务器漏洞可能存在于Windows操作系统上，但在Linux上则不存在，这一点可能未被自动扫描工具考虑。

#### 5.1.2 供应商通告(*Vendor Advisories*)

        供应商发布的安全通告和变更日志可以提供自动工具未报告的漏洞信息的指引。许多主要软件供应商会报告有限的内部发现问题的细节，以及独立研究人员协调披露的漏洞问题。如果研究人员选择对漏洞细节保持沉默，供应商通告往往是唯一可用的数据。在这些情况下，其他研究人员可能会独立发现更多细节，并将其添加到漏洞数据库中。搜索在供应商通告中使用的CVE可能会发现有关潜在可利用问题的更多细节。

        变更日志可以为进一步研究提供指导，尤其是在开源产品中，其中版本之间的差异可以揭示一个已修复但未广泛了解的漏洞，可能因此未被优先升级或安装。

### 5.2 漏洞利用数据库和框架模块(*Exploit Databases and Framework Modules*)

        许多漏洞利用数据库在互联网上被积极维护并公开访问。安全研究人员和漏洞利用编写者并不总是将他们的漏洞利用代码提交到多个网站，因此建议熟悉多个网站，并检查每个网站以获取可用于潜在漏洞应用程序的漏洞利用代码。尽管一些漏洞数据库会跟踪漏洞利用的可用性，但其覆盖范围通常不完整，不能被视为详尽无遗。

商业和开源漏洞利用框架在研究漏洞方面也可能非常有用。在大多数情况下，可用的漏洞利用模块会在他们的公共网站上列出，并且可以成为问题可利用性的有价值指示。

### 5.3 常见/默认密码(*Common/default Passwords*)

        通常，管理员和技术人员会选择弱密码，从不更改默认设置或根本不设置任何密码。大多数软件和硬件的手册可以很容易地在网上找到，并提供默认凭证。互联网论坛和官方供应商邮件列表可以提供有关未记录帐户、常用密码和常见配置错误帐户的信息。最后，许多网站文档（html文件、js文件）记录了默认/后门密码，应为每个识别的系统进行检查。

### 5.4 加固指南/常见错误配置（*Hardening Guides/Common Misconfigurations*）

        渗透测试的主要目标之一是模拟真实攻击者的策略和行为。虽然自动扫描可以缩短测试时间，但没有扫描工具能够像人类一样行动。加固指南对于渗透测试人员来说是非常有价值的参考，不仅可以突出系统中最薄弱的部分，还可以通过验证有多少建议已被实施来了解管理员的谨慎程度。在每次渗透测试中，都应花时间检查每个主要系统及其推荐的加固设置，以发现管理员留下的漏洞。

        用户论坛和邮件列表可以提供有关系统及管理员在配置和保护系统时遇到的各种问题的有价值信息。测试人员应像自己安装目标系统一样进行研究，找出瓶颈和可能的配置错误。

### 5.5 私人研究（*Private Research*）

#### 5.5.1 设置复现环境（*Setting up a replica environment*）

        虚拟化技术允许安全研究人员运行多种操作系统和应用程序，而无需专用硬件。当识别出目标操作系统或应用程序时，可以快速创建一个虚拟机（VM）环境来模拟目标。测试人员可以使用此VM探索应用程序的配置参数和行为，而无需直接连接到目标。

#### 5.5.2 测试配置（*Testing Configurations*）

        测试VM实验室应包含所有常见操作系统的基本映像，包括Windows XP、Vista、7、Server 2003和Server 2008，Debian，Ubuntu，Red Hat和Mac OS X（如果可能）。为每个服务包级别维护单独的映像将简化重建目标环境的过程。完整的VM库结合支持克隆的VM环境将允许测试人员在几分钟内启动新的目标VM。此外，使用快照功能将提高工作效率，并有助于重现错误。

#### 5.5.3 模糊测试（*Fuzzing*）

        模糊测试或故障注入是一种通过程序化提交有效、随机或意外输入给应用程序来寻找应用程序缺陷的暴力方法。基本过程包括将调试器附加到目标应用程序，然后对特定的输入区域运行模糊测试程序，并在任何崩溃后分析程序状态。虽然有许多模糊测试应用程序可用，但一些测试人员会针对特定目标编写自己的模糊测试工具。

### 5.6 识别潜在途径/向量(*Identifying potential avenues/vectors*)

        登录或连接到目标网络应用程序以识别命令和其他输入区域。如果目标是读取文件和/或网页的桌面应用程序，则分析接受的文件格式以查找数据输入途径。一些简单的测试包括提交无效字符或非常长的字符串以导致崩溃。附加调试器以在成功崩溃时分析程序状态。

### 5.7 反汇编和代码分析(*Disassembly and code analysis*)

某些编程语言允许反编译，某些特定应用程序使用带有调试符号的编译。测试人员可以利用这些功能来分析程序流程并识别潜在漏洞。开源应用程序的源代码应被分析以查找缺陷。在任何测试中，PHP编写的Web应用程序因为共享许多相同的漏洞，其源代码都应被检查。

[主页](./../README.md)        [上一页](./Threat_Modeling.md)        [下一页](./Exploitation.md)
